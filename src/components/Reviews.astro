---
const reviews = [
  {
    name: "Mariana González",
    time: "Hace 2 semanas",
    avatar: "https://randomuser.me/api/portraits/women/44.jpg",
    text: "Un santuario culinario. La atención al detalle y la complejidad de sabores colocan a Bocuze en otro nivel.",
  },
  {
    name: "Carlos R. Montiel",
    time: "Hace 1 mes",
    avatar: "https://randomuser.me/api/portraits/men/32.jpg",
    text: "El mejor lugar en Zibatá para cerrar negocios. La cava es excepcional y el ambiente íntimo.",
  },
  {
    name: "Sophie LeClerc",
    time: "Hace 3 días",
    avatar: "https://randomuser.me/api/portraits/women/68.jpg",
    text: "Una experiencia que rivaliza con cualquier bistró de primer nivel. El risotto de trufa es imperdible.",
  },
];
---

<section id="reseñas" class="section-shell section-reviews living-texture py-28">
  <div class="max-w-6xl mx-auto px-6 text-center">
    <div class="mb-14">
      <p class="reveal text-[11px] uppercase tracking-[0.38em] text-amber-200/70 mb-5">Reseñas verificadas</p>
      <h2 class="reveal text-4xl md:text-6xl font-serif text-zinc-100 italic" data-delay="1">
        Lo que dicen nuestros comensales
      </h2>
      <p class="reveal text-zinc-400 text-sm uppercase tracking-[0.3em] mt-5" data-delay="2">
        4.9 / 5 · Basado en 128 reseñas
      </p>
    </div>

    <div class="reveal relative overflow-hidden" data-delay="2" id="reviews-carousel" aria-roledescription="carousel">
      <div class="relative h-[330px] md:h-[290px]">
        {reviews.map((review, index) => (
          <article
            class={`review-slide glass-card absolute inset-0 p-8 md:p-10 text-left transition-all duration-700 ease-[cubic-bezier(0.22,1,0.36,1)] ${index === 0 ? "opacity-100 translate-x-0" : "opacity-0 translate-x-8 pointer-events-none"}`}
            data-slide={index}
            aria-hidden={index === 0 ? "false" : "true"}
          >
            <div class="absolute inset-0 overflow-hidden pointer-events-none">
              <div class="h-full w-full bg-[radial-gradient(circle_at_80%_30%,rgba(214,162,95,0.16),transparent_42%)] transition-transform duration-700" data-parallax></div>
            </div>

            <div class="relative z-10 h-full flex flex-col justify-between">
              <svg class="h-9 w-9 text-amber-300/80 mb-5" viewBox="0 0 36 36" fill="none" aria-hidden="true">
                <path d="M10 12H18L14.2 24H8L10 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round">
                  <animate attributeName="stroke-dasharray" from="0 36" to="36 0" dur="1.1s" fill="freeze" />
                </path>
                <path d="M22 12H30L26.2 24H20L22 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round">
                  <animate attributeName="stroke-dasharray" from="0 36" to="36 0" dur="1.1s" fill="freeze" begin="0.2s" />
                </path>
              </svg>

              <p class="text-zinc-200/90 text-lg md:text-2xl leading-relaxed max-w-4xl">{review.text}</p>

              <div class="mt-8 flex items-center gap-4">
                <img src={review.avatar} alt={review.name} class="w-12 h-12 rounded-full border border-amber-200/30 object-cover" loading="lazy" />
                <div>
                  <p class="text-amber-100 font-medium tracking-wide">{review.name}</p>
                  <p class="text-zinc-400 text-xs uppercase tracking-[0.24em] mt-1">{review.time}</p>
                </div>
              </div>
            </div>
          </article>
        ))}
      </div>

      <div class="mt-8 flex flex-wrap items-center justify-between gap-6">
        <div class="flex items-center gap-3" role="tablist" aria-label="Indicadores de reseñas">
          {reviews.map((_, index) => (
            <button
              class={`review-dot h-2.5 rounded-full transition-all duration-500 ${index === 0 ? "w-8 bg-amber-300" : "w-2.5 bg-zinc-500/60 hover:bg-amber-200/70"}`}
              data-dot={index}
              aria-label={`Ir a reseña ${index + 1}`}
              aria-selected={index === 0 ? "true" : "false"}
            ></button>
          ))}
        </div>

        <div class="review-progress w-full md:w-64" aria-hidden="true">
          <span id="reviews-progress-bar"></span>
        </div>
      </div>
    </div>

    <div class="reveal mt-14" data-delay="3">
      <a href="https://www.google.com/maps/search/?api=1&query=Bocuze+Bistro+Zibatá" target="_blank" class="btn-premium">
        Ver todas en Google Maps
      </a>
    </div>
  </div>

  <script is:inline>
    const initReviewsCarousel = () => {
      const root = document.getElementById("reviews-carousel");
      if (!root || root.dataset.ready === "true") return;
      root.dataset.ready = "true";

      const slides = Array.from(root.querySelectorAll(".review-slide"));
      const dots = Array.from(root.querySelectorAll(".review-dot"));
      const progress = root.querySelector("#reviews-progress-bar");
      const duration = 6500;
      let current = 0;
      let timer;

      const setProgress = () => {
        if (!progress) return;
        progress.style.transition = "none";
        progress.style.transform = "scaleX(0)";
        requestAnimationFrame(() => {
          progress.style.transition = `transform ${duration}ms linear`;
          progress.style.transform = "scaleX(1)";
        });
      };

      const activate = (nextIndex) => {
        current = nextIndex;
        slides.forEach((slide, idx) => {
          const isActive = idx === current;
          slide.classList.toggle("opacity-100", isActive);
          slide.classList.toggle("translate-x-0", isActive);
          slide.classList.toggle("opacity-0", !isActive);
          slide.classList.toggle("translate-x-8", !isActive);
          slide.classList.toggle("pointer-events-none", !isActive);
          slide.setAttribute("aria-hidden", String(!isActive));

          const parallax = slide.querySelector("[data-parallax]");
          if (parallax) {
            parallax.style.transform = isActive ? "translateX(0)" : "translateX(16px)";
          }
        });

        dots.forEach((dot, idx) => {
          const isActive = idx === current;
          dot.classList.toggle("w-8", isActive);
          dot.classList.toggle("w-2.5", !isActive);
          dot.classList.toggle("bg-amber-300", isActive);
          dot.classList.toggle("bg-zinc-500/60", !isActive);
          dot.setAttribute("aria-selected", String(isActive));
        });

        setProgress();
      };

      const queue = () => {
        clearInterval(timer);
        timer = window.setInterval(() => activate((current + 1) % slides.length), duration);
      };

      dots.forEach((dot, idx) => dot.addEventListener("click", () => {
        activate(idx);
        queue();
      }));

      root.addEventListener("mouseenter", () => clearInterval(timer));
      root.addEventListener("mouseleave", queue);

      activate(0);
      queue();
    };

    initReviewsCarousel();
    document.addEventListener("astro:after-swap", initReviewsCarousel);
  </script>
</section>
